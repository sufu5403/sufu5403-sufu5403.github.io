<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前峰國中哥布林王國</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        window.fb = {};
        window.fb.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        if (Object.keys(firebaseConfig).length > 0) {
            window.fb.app = initializeApp(firebaseConfig);
            window.fb.db = getFirestore(window.fb.app);
            window.fb.auth = getAuth(window.fb.app);

            // Sign in anonymously if no custom token, otherwise use custom token
            onAuthStateChanged(window.fb.auth, async (user) => {
                if (!user) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(window.fb.auth, __initial_auth_token);
                            console.log('Signed in with custom token');
                        } catch (error) {
                            console.error('Error signing in with custom token:', error);
                            await signInAnonymously(window.fb.auth);
                            console.log('Signed in anonymously as fallback');
                        }
                    } else {
                        await signInAnonymously(window.fb.auth);
                        console.log('Signed in anonymously');
                    }
                }
                window.fb.userId = window.fb.auth.currentUser?.uid || crypto.randomUUID(); // Get user ID after auth state is ready
                document.dispatchEvent(new CustomEvent('firebaseAuthReady')); // Notify when auth is ready
            });
        } else {
            console.error("Firebase config is empty or not provided.");
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* 設置一個基礎背景色 */
        }
        /* 客服聊天視窗的固定定位和基本樣式 */
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px; /* 聊天視窗寬度 */
            height: 450px; /* 聊天視窗高度 */
            background-color: #fff;
            border-radius: 1rem; /* 圓角 */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); /* 陰影 */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease-in-out; /* 平滑過渡效果 */
            z-index: 1000; /* 確保在最上層 */
        }

        /* 最小化狀態 */
        .chat-container.minimized {
            width: 60px;
            height: 60px;
            bottom: 20px;
            right: 20px;
            border-radius: 50%; /* 變成圓形 */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
        }

        /* 聊天訊息區塊樣式 */
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f9fafb; /* 淺灰色背景 */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        /* 聊天訊息泡泡樣式 */
        .message-bubble {
            max-width: 80%;
            padding: 0.6rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
        }

        .message-bubble.user {
            background-color: #3B82F6; /* 藍色 */
            color: white;
            margin-left: auto; /* 靠右對齊 */
            border-bottom-right-radius: 0.2rem;
        }

        .message-bubble.ai {
            background-color: #E5E7EB; /* 淺灰 */
            color: #1F2937;
            margin-right: auto; /* 靠左對齊 */
            border-bottom-left-radius: 0.2rem;
        }

        /* 隱藏聊天視窗內容（最小化時） */
        .chat-container.minimized .chat-header,
        .chat-container.minimized .chat-messages,
        .chat-container.minimized .chat-input-area {
            display: none;
        }

        /* 最小化按鈕的圖示 */
        .chat-container.minimized .chat-toggle-button {
            display: block; /* 最小化時顯示按鈕 */
            font-size: 2rem;
            color: #4B5563;
        }

        /* 浮動按鈕的樣式 */
        .floating-chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #10B981; /* 綠色 */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease-in-out;
            z-index: 1001; /* 確保在最上層 */
        }

        .floating-chat-button:hover {
            transform: scale(1.1);
            background-color: #059669;
        }

        .log-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
        }
        .log-item:last-child {
            border-bottom: none;
        }
        .log-item span {
            color: #ccc;
        }
        .log-item .log-ip {
            color: #81C784; /* Light green for IP */
            font-weight: bold;
        }
        .log-item .log-time {
            color: #FFD54F; /* Amber for time */
            font-style: italic;
        }
        .log-item .log-user {
            color: #90CAF9; /* Light blue for user ID */
            font-size: 0.8em;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-400 to-blue-500">
    <!-- 主要內容區塊 -->
    <div id="mainContent" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-4xl w-full text-center transform transition-all duration-300 hover:scale-105">
            <h1 class="text-5xl font-extrabold text-gray-900 mb-6 leading-tight">
                前峰國中哥布林王國
            </h1>

            <p class="text-xl text-gray-700 mb-8">
                哥布林王國,成立於2025年3月11日,是一個由國中單身男女組成的聊天聚落。
                我們自稱「哥布林」,不為別的,只因單身但不孤單,搞笑又真誠,嘴砲中帶點溫柔,日常中充滿火花。
                這裡沒有王子公主,只有一群在訊息裡互相鬧互相挺的哥布林夥伴。
            </p>

            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-6 rounded-lg mb-8 shadow-md">
                <h2 class="text-2xl font-bold mb-3 flex items-center justify-center">
                    <svg class="w-7 h-7 mr-3 text-yellow-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.542 2.705-1.542 3.47 0l5.58 11.23c.75 1.51.148 3.3-1.565 3.3H4.242c-1.713 0-2.315-1.79-.164-3.3l5.58-11.23zM11 15a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V7a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    聲明！
                </h2>
                <p class="text-lg">
                    追蹤我們的帳號，將會無條件拉您進入我們的專屬社群群組！
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200 flex flex-col items-center">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">總統</h3>
                    <a href="https://www.instagram.com/qwer789456321/" target="_blank" rel="noopener noreferrer" class="text-gray-700 text-lg flex items-center hover:text-blue-600 transition-colors duration-200">
                        @qwer789456321
                        <svg class="w-5 h-5 ml-2 text-pink-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12.315 2c2.43 0 2.784.013 3.808.06 1.064.049 1.791.217 2.428.465.66.254 1.216.598 1.772 1.154.556.556.909 1.112 1.154 1.772.248.637.416 1.364.465 2.428.047 1.024.06 1.379.06 3.808v.63a4.5 4.5 0 01-.07 1.006c-.035.52-.103 1.06-.271 1.59-.147.45-.33.86-.53 1.22-.205.36-.461.66-.776.975-.315.315-.615.571-.975.776-.36.2-.77.383-1.22.53-.53.168-1.07.236-1.59.271a4.5 4.5 0 01-1.006.07h-.63c-2.43 0-2.784-.013-3.808-.06-1.064-.049-1.791-.217-2.428-.465-.66-.254-1.216-.598-1.772-1.154-.556-.556-.909-1.112-1.154-1.772-.248-.637-.416-1.364-.465-2.428C2.013 14.784 2 14.43 2 12v-.63c0-2.43.013-2.784.06-3.808.049-1.064.217-1.791.465-2.428.254-.66.598-1.216 1.154-1.772.556-.556 1.112-.909 1.772-1.154.637-.248 1.364-.416 2.428-.465C9.216 2.013 9.57 2 12 2zm0 2.16a7.84 7.84 0 100 15.68 7.84 7.84 0 000-15.68zm0 3.87a5.81 5.81 0 110 11.62 5.81 5.81 0 010-11.62zm0 2.16a3.65 3.65 0 100 7.3 3.65 3.65 0 000-7.3zM16.5 7.17a1.2 1.2 0 110 2.4 1.2 1.2 0 010-2.4z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
                <div class="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200 flex flex-col items-center">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">副總統</h3>
                    <a href="https://www.instagram.com/e1310510/" target="_blank" rel="noopener noreferrer" class="text-gray-700 text-lg flex items-center hover:text-blue-600 transition-colors duration-200">
                        @e1310510
                        <svg class="w-5 h-5 ml-2 text-pink-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12.315 2c2.43 0 2.784.013 3.808.06 1.064.049 1.791.217 2.428.465.66.254 1.216.598 1.772 1.154.556.556.909 1.112 1.154 1.772.248.637.416 1.364.465 2.428.047 1.024.06 1.379.06 3.808v.63a4.5 4.5 0 01-.07 1.006c-.035.52-.103 1.06-.271 1.59-.147.45-.33.86-.53 1.22-.205.36-.461.66-.776.975-.315.315-.615.571-.975.776-.36.2-.77.383-1.22.53-.53.168-1.07.236-1.59.271a4.5 4.5 0 01-1.006.07h-.63c-2.43 0-2.784-.013-3.808-.06-1.064-.049-1.791-.217-2.428-.465-.66-.254-1.216-.598-1.772-1.154-.556-.556-.909-1.112-1.154-1.772-.248-.637-.416-1.364-.465-2.428C2.013 14.784 2 14.43 2 12v-.63c0-2.43.013-2.784.06-3.808.049-1.064.217-1.791.465-2.428.254-.66.598-1.216 1.154-1.772.556-.556 1.112-.909 1.772-1.154.637-.248 1.364-.416 2.428-.465C9.216 2.013 9.57 2 12 2zm0 2.16a7.84 7.84 0 100 15.68 7.84 7.84 0 000-15.68zm0 3.87a5.81 5.81 0 110 11.62 5.81 5.81 0 010-11.62zm0 2.16a3.65 3.65 0 100 7.3 3.65 3.65 0 000-7.3zM16.5 7.17a1.2 1.2 0 110 2.4 1.2 1.2 0 010-2.4z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
                <div class="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200 flex flex-col items-center">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">總部總裁</h3>
                    <a href="https://www.instagram.com/kerry_magic666/" target="_blank" rel="noopener noreferrer" class="text-gray-700 text-lg flex items-center hover:text-blue-600 transition-colors duration-200">
                        @kerry_magic666
                        <svg class="w-5 h-5 ml-2 text-pink-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12.315 2c2.43 0 2.784.013 3.808.06 1.064.049 1.791.217 2.428.465.66.254 1.216.598 1.772 1.154.556.556.909 1.112 1.154 1.772.248.637.416 1.364.465 2.428.047 1.024.06 1.379.06 3.808v.63a4.5 4.5 0 01-.07 1.006c-.035.52-.103 1.06-.271 1.59-.147.45-.33.86-.53 1.22-.205.36-.461.66-.776.975-.315.315-.615.571-.975.776-.36.2-.77.383-1.22.53-.53.168-1.07.236-1.59.271a4.5 4.5 0 01-1.006.07h-.63c-2.43 0-2.784-.013-3.808-.06-1.064-.049-1.791-.217-2.428-.465-.66-.254-1.216-.598-1.772-1.154-.556-.556-.909-1.112-1.154-1.772-.248-.637-.416-1.364-.465-2.428C2.013 14.784 2 14.43 2 12v-.63c0-2.43.013-2.784.06-3.808.049-1.064.217-1.791.465-2.428.254-.66.598-1.216 1.154-1.772.556-.556 1.112-.909 1.772-1.154.637-.248 1.364-.416 2.428-.465C9.216 2.013 9.57 2 12 2zm0 2.16a7.84 7.84 0 100 15.68 7.84 7.84 0 000-15.68zm0 3.87a5.81 5.81 0 110 11.62 5.81 5.81 0 010-11.62zm0 2.16a3.65 3.65 0 100 7.3 3.65 3.65 0 000-7.3zM16.5 7.17a1.2 1.2 0 110 2.4 1.2 1.2 0 010-2.4z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
                <div class="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200 flex flex-col items-center">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">小混混</h3>
                    <a href="https://www.instagram.com/89._.dry/" target="_blank" rel="noopener noreferrer" class="text-gray-700 text-lg flex items-center hover:text-blue-600 transition-colors duration-200">
                        @89._.dry
                        <svg class="w-5 h-5 ml-2 text-pink-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12.315 2c2.43 0 2.784.013 3.808.06 1.064.049 1.791.217 2.428.465.66.254 1.216.598 1.772 1.154.556.556.909 1.112 1.154 1.772.248.637.416 1.364.465 2.428.047 1.024.06 1.379.06 3.808v.63a4.5 4.5 0 01-.07 1.006c-.035.52-.103 1.06-.271 1.59-.147.45-.33.86-.53 1.22-.205.36-.461.66-.776.975-.315.315-.615.571-.975.776-.36.2-.77.383-1.22.53-.53.168-1.07.236-1.59.271a4.5 4.5 0 01-1.006.07h-.63c-2.43 0-2.784-.013-3.808-.06-1.064-.049-1.791-.217-2.428-.465-.66-.254-1.216-.598-1.772-1.154-.556-.556-.909-1.112-1.154-1.772-.248-.637-.416-1.364-.465-2.428C2.013 14.784 2 14.43 2 12v-.63c0-2.43.013-2.784.06-3.808.049-1.064.217-1.791.465-2.428.254-.66.598-1.216 1.154-1.772.556-.556 1.112-.909 1.772-1.154.637-.248 1.364-.416 2.428-.465C9.216 2.013 9.57 2 12 2zm0 2.16a7.84 7.84 0 100 15.68 7.84 7.84 0 000-15.68zm0 3.87a5.81 5.81 0 110 11.62 5.81 5.81 0 010-11.62zm0 2.16a3.65 3.65 0 100 7.3 3.65 3.65 0 000-7.3zM16.5 7.17a1.2 1.2 0 110 2.4 1.2 1.2 0 010-2.4z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
                <div class="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200 flex flex-col items-center">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">小編</h3>
                    <a href="https://www.instagram.com/kerry_magic666/" target="_blank" rel="noopener noreferrer" class="text-gray-700 text-lg flex items-center hover:text-blue-600 transition-colors duration-200">
                        @kerry_magic666
                        <svg class="w-5 h-5 ml-2 text-pink-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12.315 2c2.43 0 2.784.013 3.808.06 1.064.049 1.791.217 2.428.465.66.254 1.216.598 1.772 1.154.556.556.909 1.112 1.154 1.772.248.637.416 1.364.465 2.428.047 1.024.06 1.379.06 3.808v.63a4.5 4.5 0 01-.07 1.006c-.035.52-.103 1.06-.271 1.59-.147.45-.33.86-.53 1.22-.205.36-.461.66-.776.975-.315.315-.615.571-.975.776-.36.2-.77.383-1.22.53-.53.168-1.07.236-1.59.271a4.5 4.5 0 01-1.006.07h-.63c-2.43 0-2.784-.013-3.808-.06-1.064-.049-1.791-.217-2.428-.465-.66-.254-1.216-.598-1.772-1.154-.556-.556-.909-1.112-1.154-1.772-.248-.637-.416-1.364-.465-2.428C2.013 14.784 2 14.43 2 12v-.63c0-2.43.013-2.784.06-3.808.049-1.064.217-1.791.465-2.428.254-.66.598-1.216 1.154-1.772.556-.556 1.112-.909 1.772-1.154.637-.248 1.364-.416 2.428-.465C9.216 2.013 9.57 2 12 2zm0 2.16a7.84 7.84 0 100 15.68 7.84 7.84 0 000-15.68zm0 3.87a5.81 5.81 0 110 11.62 5.81 5.81 0 010-11.62zm0 2.16a3.65 3.65 0 100 7.3 3.65 3.65 0 000-7.3zM16.5 7.17a1.2 1.2 0 110 2.4 1.2 1.2 0 010-2.4z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
                <div class="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200 flex flex-col items-center">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">網站設計師</h3>
                    <a href="https://www.instagram.com/sufu5403/" target="_blank" rel="noopener noreferrer" class="text-gray-700 text-lg flex items-center hover:text-blue-600 transition-colors duration-200">
                        @sufu5403
                        <svg class="w-5 h-5 ml-2 text-pink-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12.315 2c2.43 0 2.784.013 3.808.06 1.064.049 1.791.217 2.428.465.66.254 1.216.598 1.772 1.154.556.556.909 1.112 1.154 1.772.248.637.416 1.364.465 2.428.047 1.024.06 1.379.06 3.808v.63a4.5 4.5 0 01-.07 1.006c-.035.52-.103 1.06-.271 1.59-.147.45-.33.86-.53 1.22-.205.36-.461.66-.776.975-.315.315-.615.571-.975.776-.36.2-.77.383-1.22.53-.53.168-1.07.236-1.59.271a4.5 4.5 0 01-1.006.07h-.63c-2.43 0-2.784-.013-3.808-.06-1.064-.049-1.791-.217-2.428-.465-.66-.254-1.216-.598-1.772-1.154-.556-.556-.909-1.112-1.154-1.772-.248-.637-.416-1.364-.465-2.428C2.013 14.784 2 14.43 2 12v-.63c0-2.43.013-2.784.06-3.808.049-1.064.217-1.791.465-2.428.254-.66.598-1.216 1.154-1.772.556-.556 1.112-.909 1.772-1.154.637-.248 1.364-.416 2.428-.465C9.216 2.013 9.57 2 12 2zm0 2.16a7.84 7.84 0 100 15.68 7.84 7.84 0 000-15.68zm0 3.87a5.81 5.81 0 110 11.62 5.81 5.81 0 010-11.62zm0 2.16a3.65 3.65 0 100 7.3 3.65 3.65 0 000-7.3zM16.5 7.17a1.2 1.2 0 110 2.4 1.2 1.2 0 010-2.4z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
            </div>

            <p class="text-gray-500 text-sm mt-8">
                © 2025 前峰國中哥布林王國. 版權所有.
            </p>

            <!-- 進入後台按鈕 -->
            <button id="enterAdminButton" class="mt-8 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                進入後台系統
            </button>
        </div>
    </div>

    <!-- 後台系統區塊 (預設隱藏) -->
    <div id="adminPanel" class="hidden flex flex-col min-h-screen p-4 bg-slate-900 text-white">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-4xl w-full text-center mx-auto mb-8">
            <h1 class="text-5xl font-extrabold text-blue-200 mb-6 leading-tight">
                後台管理系統
            </h1>
            <p class="text-xl text-gray-300 mb-8">
                歡迎來到管理員頁面。這裡將用於網站的內部管理和設定。
            </p>

            <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 後台登入紀錄 -->
                <div class="bg-slate-700 p-6 rounded-lg shadow-md">
                    <h3 class="text-2xl font-semibold text-blue-300 mb-4">後台登入紀錄</h3>
                    <div id="adminLoginRecords" class="text-left overflow-y-auto max-h-60">
                        <p class="text-gray-400 text-center">載入中...</p>
                    </div>
                </div>

                <!-- 網站訪問紀錄 -->
                <div class="bg-slate-700 p-6 rounded-lg shadow-md">
                    <h3 class="text-2xl font-semibold text-blue-300 mb-4">網站訪問紀錄</h3>
                    <div id="websiteAccessRecords" class="text-left overflow-y-auto max-h-60">
                        <p class="text-gray-400 text-center">載入中...</p>
                    </div>
                </div>
            </div>

            <!-- 返回首頁按鈕 -->
            <button id="returnHomeButton" class="mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                返回首頁
            </button>
        </div>
    </div>

    <!-- 後台密碼輸入模態框 (預設隱藏) -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-20">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h2 class="text-2xl font-bold text-white mb-4">輸入後台密碼</h2>
            <input type="password" id="adminPasswordInput" placeholder="請輸入密碼" class="w-full p-3 rounded-md border border-gray-600 bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
            <p id="passwordError" class="text-red-400 mt-2 hidden">密碼錯誤，請再試一次。</p>
            <button id="submitAdminPassword" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-md transition duration-200">
                確認
            </button>
            <button id="cancelAdminPassword" class="mt-6 ml-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition duration-200">
                取消
            </button>
        </div>
    </div>

    <div id="chatToggleButton" class="floating-chat-button">
        💬
    </div>

    <div id="chatWindow" class="chat-container hidden">
        <div class="chat-header bg-gray-800 text-white p-4 flex justify-between items-center rounded-t-xl">
            <h3 class="text-lg font-semibold">前峰國中哥布林王國客服</h3>
            <div>
                <button id="minimizeChat" class="text-gray-300 hover:text-white mr-2 text-2xl leading-none">&minus;</button>
                <button id="closeChat" class="text-gray-300 hover:text-white text-2xl leading-none">&times;</button>
            </div>
        </div>
        <div id="chatMessages" class="chat-messages flex-grow p-4 overflow-y-auto">
            <div class="message-bubble ai">您好！我是前峰國中哥布林王國的客服，有什麼可以為您服務的嗎？</div>
        </div>
        <div class="chat-input-area p-4 border-t border-gray-200 flex items-center">
            <input type="text" id="chatInput" placeholder="輸入您的訊息..." class="flex-grow p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
            <button id="sendMessage" class="ml-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-md transition duration-200">
                傳送
            </button>
        </div>
        <div id="chatLoading" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden rounded-xl">
            <div class="text-gray-700 text-lg font-semibold">思考中...</div>
        </div>
    </div>

    <script type="module">
        import { getFirestore, addDoc, collection, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const chatToggleButton = document.getElementById('chatToggleButton');
            const chatWindow = document.getElementById('chatWindow');
            const minimizeChatButton = document.getElementById('minimizeChat');
            const closeChatButton = document.getElementById('closeChat');
            const chatMessagesDiv = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendMessageButton = document.getElementById('sendMessage');
            const chatLoading = document.getElementById('chatLoading');

            const mainContentDiv = document.getElementById('mainContent');
            const adminPanelDiv = document.getElementById('adminPanel');
            const enterAdminButton = document.getElementById('enterAdminButton');
            const returnHomeButton = document.getElementById('returnHomeButton');

            const passwordModal = document.getElementById('passwordModal');
            const adminPasswordInput = document.getElementById('adminPasswordInput');
            const passwordError = document.getElementById('passwordError');
            const submitAdminPasswordButton = document.getElementById('submitAdminPassword');
            const cancelAdminPasswordButton = document.getElementById('cancelAdminPassword');

            const adminLoginRecordsDiv = document.getElementById('adminLoginRecords');
            const websiteAccessRecordsDiv = document.getElementById('websiteAccessRecords');

            const ADMIN_PASSWORD = '1313'; // 固定密碼

            let chatHistory = [{
                role: "model",
                parts: [{ text: "您好！我是前峰國中哥布林王國的客服，有什麼可以為您服務的嗎？" }]
            }];

            let db, userId; // Firebase instances and user ID

            // Function to get user's public IP address
            async function getUserIP() {
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    return data.ip;
                } catch (error) {
                    console.error('Error fetching IP:', error);
                    return '未知 IP';
                }
            }

            // Function to log admin login to Firestore
            async function logAdminLogin() {
                if (!db || !userId) {
                    console.error("Firestore or User ID not initialized for logging.");
                    return;
                }
                const ip = await getUserIP();
                try {
                    const loginsColRef = collection(db, `artifacts/${window.fb.appId}/public/data/admin_logins`);
                    await addDoc(loginsColRef, {
                        ip: ip,
                        timestamp: serverTimestamp(),
                        userId: userId
                    });
                } catch (e) {
                    console.error("Error adding admin login document: ", e);
                }
            }

            // Function to log website access to Firestore
            async function logWebsiteAccess() {
                if (!db || !userId) {
                    console.error("Firestore or User ID not initialized for logging.");
                    return;
                }
                const ip = await getUserIP();
                try {
                    const accessColRef = collection(db, `artifacts/${window.fb.appId}/public/data/website_accesses`);
                    await addDoc(accessColRef, {
                        ip: ip,
                        timestamp: serverTimestamp(),
                        userId: userId
                    });
                } catch (e) {
                    console.error("Error adding website access document: ", e);
                }
            }

            // Fetch and display admin login records
            function fetchAdminLoginRecords() {
                if (!db) {
                    adminLoginRecordsDiv.innerHTML = '<p class="text-red-400 text-center">Firestore 未初始化。</p>';
                    return;
                }
                const q = query(collection(db, `artifacts/${window.fb.appId}/public/data/admin_logins`)); // Removed orderBy
                onSnapshot(q, (snapshot) => {
                    adminLoginRecordsDiv.innerHTML = '';
                    if (snapshot.empty) {
                        adminLoginRecordsDiv.innerHTML = '<p class="text-gray-400 text-center">沒有登入紀錄。</p>';
                        return;
                    }
                    // Sort in memory by timestamp in descending order
                    const sortedDocs = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                    sortedDocs.forEach((doc) => {
                        const data = doc;
                        const time = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString('zh-TW') : 'N/A';
                        const item = document.createElement('div');
                        item.classList.add('log-item');
                        item.innerHTML = `
                            <span class="log-ip">${data.ip}</span>
                            <span class="log-user">用戶ID: ${data.userId}</span>
                            <span class="log-time">${time}</span>
                        `;
                        adminLoginRecordsDiv.appendChild(item);
                    });
                }, (error) => {
                    console.error("Error fetching admin login records: ", error);
                    adminLoginRecordsDiv.innerHTML = `<p class="text-red-400 text-center">載入紀錄失敗: ${error.message}</p>`;
                });
            }

            // Fetch and display website access records
            function fetchWebsiteAccessRecords() {
                if (!db) {
                    websiteAccessRecordsDiv.innerHTML = '<p class="text-red-400 text-center">Firestore 未初始化。</p>';
                    return;
                }
                const q = query(collection(db, `artifacts/${window.fb.appId}/public/data/website_accesses`)); // Removed orderBy
                onSnapshot(q, (snapshot) => {
                    websiteAccessRecordsDiv.innerHTML = '';
                    if (snapshot.empty) {
                        websiteAccessRecordsDiv.innerHTML = '<p class="text-gray-400 text-center">沒有網站訪問紀錄。</p>';
                        return;
                    }
                    // Sort in memory by timestamp in descending order
                    const sortedDocs = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                    sortedDocs.forEach((doc) => {
                        const data = doc;
                        const time = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString('zh-TW') : 'N/A';
                        const item = document.createElement('div');
                        item.classList.add('log-item');
                        item.innerHTML = `
                            <span class="log-ip">${data.ip}</span>
                            <span class="log-user">用戶ID: ${data.userId}</span>
                            <span class="log-time">${time}</span>
                        `;
                        websiteAccessRecordsDiv.appendChild(item);
                    });
                }, (error) => {
                    console.error("Error fetching website access records: ", error);
                    websiteAccessRecordsDiv.innerHTML = `<p class="text-red-400 text-center">載入紀錄失敗: ${error.message}</p>`;
                });
            }

            // Event listener for Firebase Auth Ready
            document.addEventListener('firebaseAuthReady', () => {
                db = window.fb.db;
                userId = window.fb.userId;
                console.log("Firebase initialized and user ID available:", userId);

                // Log website access only after Firebase is ready and user ID is established
                logWebsiteAccess();
            });

            // 顯示/隱藏聊天視窗
            chatToggleButton.addEventListener('click', () => {
                chatWindow.classList.toggle('hidden');
                chatWindow.classList.remove('minimized');
                chatToggleButton.classList.add('hidden');
                scrollToBottom();
            });

            // 最小化聊天視窗
            minimizeChatButton.addEventListener('click', () => {
                chatWindow.classList.add('minimized');
                chatToggleButton.classList.remove('hidden');
            });

            // 關閉聊天視窗
            closeChatButton.addEventListener('click', () => {
                chatWindow.classList.add('hidden');
                chatWindow.classList.remove('minimized');
                chatToggleButton.classList.remove('hidden');
            });

            // 點擊最小化後的圓形按鈕重新打開
            chatWindow.addEventListener('click', (event) => {
                if (chatWindow.classList.contains('minimized')) {
                    chatWindow.classList.remove('minimized');
                    chatWindow.classList.remove('hidden');
                    chatToggleButton.classList.add('hidden');
                    scrollToBottom();
                    event.stopPropagation();
                }
            });

            // 滾動到聊天訊息底部
            function scrollToBottom() {
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            }

            // 顯示訊息到聊天視窗
            function displayMessage(message, sender) {
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('message-bubble', sender);
                messageBubble.innerHTML = message;
                chatMessagesDiv.appendChild(messageBubble);
                scrollToBottom();
            }

            // 顯示主要內容並隱藏後台系統
            function showMainContent() {
                mainContentDiv.classList.remove('hidden');
                adminPanelDiv.classList.add('hidden');
                chatToggleButton.classList.remove('hidden');
                chatWindow.classList.add('hidden');
            }

            // 顯示後台系統並隱藏主要內容
            function showAdminPanel() {
                mainContentDiv.classList.add('hidden');
                adminPanelDiv.classList.remove('hidden');
                chatToggleButton.classList.remove('hidden');
                chatWindow.classList.add('hidden');
                // Fetch and display logs when admin panel is shown
                fetchAdminLoginRecords();
                fetchWebsiteAccessRecords();
            }

            // 後台密碼模態框相關函式
            function showPasswordModal() {
                passwordModal.classList.remove('hidden');
                adminPasswordInput.value = '';
                passwordError.classList.add('hidden');
                adminPasswordInput.focus();
            }

            function hidePasswordModal() {
                passwordModal.classList.add('hidden');
            }

            // 綁定切換按鈕事件
            enterAdminButton.addEventListener('click', showPasswordModal);
            returnHomeButton.addEventListener('click', showMainContent);

            // 密碼模態框的確認按鈕事件
            submitAdminPasswordButton.addEventListener('click', async () => {
                const enteredPassword = adminPasswordInput.value.trim();
                if (enteredPassword === ADMIN_PASSWORD) {
                    hidePasswordModal();
                    await logAdminLogin(); // Log successful admin login
                    showAdminPanel();
                } else {
                    passwordError.textContent = '密碼錯誤，請再試一次。';
                    passwordError.classList.remove('hidden');
                }
            });

            // 密碼輸入框按 Enter 鍵觸發確認
            adminPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitAdminPasswordButton.click();
                }
            });

            // 密碼模態框的取消按鈕事件
            cancelAdminPasswordButton.addEventListener('click', hidePasswordModal);


            // 傳送訊息
            async function sendMessage() {
                const userMessage = chatInput.value.trim();
                if (userMessage === '') return;

                displayMessage(userMessage, 'user');
                chatInput.value = '';

                chatLoading.classList.remove('hidden');

                if (userMessage.includes('管理員密碼') || userMessage.includes('後台密碼') || userMessage.includes('admin password')) {
                    displayMessage(`目前的後台密碼是：<span class="font-bold text-green-600">${ADMIN_PASSWORD}</span>。`, 'ai');
                    chatLoading.classList.add('hidden');
                    return;
                }

                let promptTextForLLM = '';
                const websiteContent = `
                    網站標題：前峰國中哥布林王國
                    網站簡介：哥布林王國,成立於2025年3月11日,是一個由國中單身男女組成的聊天聚落。我們自稱「哥布林」,不為別的,只因單身但不孤單,搞笑又真誠,嘴砲中帶點溫柔,日常中充滿火花。這裡沒有王子公主,只有一群在訊息裡互相鬧互相挺的哥布林夥伴。
                    聲明：追蹤我們的帳號，將會無條件拉您進入我們的專屬社群群組！
                    幹部列表：
                    - 總統: @qwer789456321 (Instagram: https://www.instagram.com/qwer789456321/)
                    - 副總統: @e1310510 (Instagram: https://www.instagram.com/e1310510/)
                    - 總部總裁: @kerry_magic666 (Instagram: https://www.instagram.com/kerry_magic666/)
                    - 小混混: @89._.dry (Instagram: https://www.instagram.com/89._.dry/)
                    - 小編: @kerry_magic666 (Instagram: https://www.instagram.com/kerry_magic666/)
                    - 網站設計師: @sufu5403 (Instagram: https://www.instagram.com/sufu5403/)
                    後台系統：本網站包含一個管理員後台系統，採用深藍黑色系設計，供內部管理使用。您可以通過首頁上的「進入後台系統」按鈕進入此頁面。進入後台系統需要一個固定密碼：1313。您可以向客服（我）詢問當前密碼。後台系統只顯示後台登入的 IP 和網站訪問的 IP 紀錄。
                `;

                promptTextForLLM = `你是一個前峰國中哥布林王國的客服人員。你的職責是根據以下提供的網站內容來回答問題。如果問題與網站內容無關，請禮貌地回答：'抱歉，我只能回答與前峰國中哥布林王國網站相關的問題。'

                當提到成員的 Instagram 帳號時，請將其格式化為 HTML 連結。例如：<a href="[IG網址]" target="_blank" rel="noopener noreferrer" class="font-semibold text-blue-600 hover:underline">@使用者名稱</a>。

                以下是網站內容：
                ${websiteContent}

                使用者問題：${userMessage}
                `;

                try {
                    let chatHistoryForLLM = [];
                    chatHistoryForLLM.push({ role: "user", parts: [{ text: promptTextForLLM }] });

                    const payload = { contents: chatHistoryForLLM };
                    const apiKey = "YOUR_GEMINI_API_KEY"; // Replace with your actual Gemini API key if needed
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiResponse = result.candidates[0].content.parts[0].text;
                        displayMessage(aiResponse, 'ai');
                        chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
                        chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                    } else {
                        displayMessage('抱歉，我無法理解您的意思，請再試一次。', 'ai');
                        console.error('Gemini API response structure unexpected:', result);
                    }
                } catch (error) {
                    displayMessage('與客服連線時發生錯誤，請稍後再試。', 'ai');
                    console.error('Error calling Gemini API:', error);
                } finally {
                    chatLoading.classList.add('hidden');
                }
            }

            sendMessageButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
    <script type="text/plain">
        <!-- Firestore Security Rules (IMPORTANT) -->
        <!-- These rules must be set in your Firebase project's Firestore console -->
        <!-- Go to Firebase Console -> Firestore Database -> Rules Tab -->
        <!-- Replace YOUR_APP_ID with your actual app ID from the Canvas environment -->
        <!-- Ensure you publish these rules after making changes -->
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /artifacts/{appId} {
              // Public data for admin logins
              match /public/data/admin_logins/{document=**} {
                allow read, create: if request.auth != null;
                allow write: if false; // Only allow creation, no direct updates or deletes via client
              }
              // Public data for website accesses
              match /public/data/website_accesses/{document=**} {
                allow read, create: if request.auth != null;
                allow write: if false; // Only allow creation, no direct updates or deletes via client
              }

              // Private user data (if any, current app doesn't use it)
              match /users/{userId}/{document=**} {
                allow read, write: if request.auth != null && request.auth.uid == userId;
              }
            }
          }
        }
    </script>
</body>
</html>
